# imoics.com: Git pull + server build on cPanel (public_html/omni)
# à¦²à§‡à¦Ÿà§‡à¦¸à§à¦Ÿ à¦•à§‹à¦¡ pull à¦•à¦°à§‡ server à¦«à§‹à¦²à§à¦¡à¦¾à¦°à§‡ npm install à¦“ build à¦šà¦¾à¦²à¦¾à¦¯à¦¼à¥¤
# GitHub Secrets: CPANEL_HOST, CPANEL_USER, SSH_PRIVATE_KEY, SSH_PORT (optional, default 2222)

name: Deploy imoics.com (Git Pull + Build)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Pull and Build on cPanel
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH (git pull + build)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 2222 }}
          script: |
            set -e
            REPO_DIR="/home/imocis/public_html/omni"
            if [ ! -d "$REPO_DIR" ]; then
              echo "ERROR: $REPO_DIR not found. Clone the repo first (e.g. git clone ... omni)."
              exit 1
            fi
            cd "$REPO_DIR"
            git fetch origin
            git reset --hard origin/main 2>/dev/null || git reset --hard origin/master
            echo "âœ… Code updated to latest from GitHub."
            cd server
            npm install
            npm run build
            echo "âœ… Server build done."
            echo "ğŸ‘‰ cPanel Node.js Selector à¦¥à§‡à¦•à§‡ à¦…à§à¦¯à¦¾à¦ª Restart à¦•à¦°à§à¦¨ (imoics.com)à¥¤"
