// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// 0. Multi-Tenant (Company/Tenant)
// ============================================

model Company {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  address     String?  @db.Text
  industry    String?  @db.VarChar(100)
  website     String?  @db.VarChar(255)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users              User[]
  employees          Employee[]
  departments        Department[]
  clients            Client[]
  tasks              Task[]
  invoices           Invoice[]
  transactions       Transaction[]
  budgets            Budget[]
  accountsPayable    AccountPayable[]
  accountsReceivable AccountReceivable[]
  companyContacts    CompanyContact[]
  contracts          Contract[]
  integrations       Integration[]
  socialConversations SocialConversation[]
  expenseCategories  ExpenseCategory[]
  leadCategories     LeadCategory[]
  leadInterests      LeadInterest[]
  systemSettings    SystemSetting[]

  @@index([name])
  @@index([isActive])
  @@map("companies")
}

// ============================================
// 1. Authentication & Users
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  permissions Json // e.g., {"can_manage_companies": true, "can_manage_inbox": false}
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model User {
  id           String   @id @default(uuid())
  email        String   @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  roleId       Int      @map("role_id")
  companyId    Int      @map("company_id")
  profileImage String?  @map("profile_image") @db.VarChar(500)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  role     Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee?
  taskComments TaskComment[]
  createdLeads Lead[] @relation("LeadCreator")

  @@unique([email, companyId])
  @@index([email])
  @@index([roleId])
  @@index([companyId])
  @@map("users")
}

// ============================================
// 2. Company Structure
// ============================================

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  companyId Int      @map("company_id")
  managerId Int?     @unique @map("manager_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company          Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager          Employee?  @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  employees        Employee[] @relation("DepartmentEmployees")

  @@index([companyId])
  @@index([managerId])
  @@map("departments")
}

model Employee {
  id           Int       @id @default(autoincrement())
  userId     String    @unique @map("user_id") @db.VarChar(36)
  companyId  Int       @map("company_id")
  department String?   @db.VarChar(100)
  departmentId Int?    @map("department_id")
  designation String?  @db.VarChar(100)
  salary      Decimal?  @db.Decimal(10, 2)
  joinDate    DateTime? @map("join_date") @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  company          Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  departmentRelation Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id], onDelete: SetNull)
  managedDepartment Department? @relation("DepartmentManager")

  // Relations
  assignedLeads Lead[]
  assignedTasks Task[]

  @@index([userId])
  @@index([companyId])
  @@index([departmentId])
  @@map("employees")
}

// ============================================
// 3. CRM (Sales)
// ============================================

model Client {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(255)
  contactInfo Json?    @map("contact_info") // e.g., {"phone": "+1234567890", "email": "client@example.com"}
  address     String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices Invoice[]
  accountsReceivable AccountReceivable[]

  @@index([companyId])
  @@map("clients")
}

model LeadCategory {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leads   Lead[]

  @@index([companyId])
  @@index([isActive])
  @@map("lead_categories")
}

model LeadInterest {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leads   Lead[]

  @@index([companyId])
  @@index([isActive])
  @@map("lead_interests")
}

enum LeadSource {
  Website
  Referral
  SocialMedia
  Email
  Phone
  Inbox
  Other

  @@map("lead_source")
}

enum LeadStatus {
  New
  Contacted
  Qualified
  Negotiation
  Won
  Lost

  @@map("lead_status")
}

model Lead {
  id             Int        @id @default(autoincrement())
  createdBy      String     @map("created_by") // User ID who created the lead
  title          String     @db.VarChar(255)
  description    String?    @db.Text
  source         LeadSource @default(Website)
  status         LeadStatus @default(New)
  assignedTo     Int?       @map("assigned_to")
  value          Decimal?   @db.Decimal(12, 2)
  conversationId Int?       @map("conversation_id") // Link to SocialConversation if from inbox
  customerName   String?    @map("customer_name") @db.VarChar(255)
  phone          String?    @db.VarChar(50)
  categoryId     Int?       @map("category_id")
  interestId     Int?       @map("interest_id")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  createdByUser  User            @relation("LeadCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  assignedEmployee Employee?      @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
  conversation     SocialConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  category         LeadCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  interest         LeadInterest?  @relation(fields: [interestId], references: [id], onDelete: SetNull)

  @@index([createdBy])
  @@index([assignedTo])
  @@index([status])
  @@index([conversationId])
  @@index([categoryId])
  @@index([interestId])
  @@map("leads")
}

// ============================================
// 4. Task Management
// ============================================

enum TaskPriority {
  Low
  Medium
  High

  @@map("task_priority")
}

enum TaskStatus {
  Todo
  InProgress
  Done

  @@map("task_status")
}

model Task {
  id          Int          @id @default(autoincrement())
  companyId   Int          @map("company_id")
  title       String       @db.VarChar(255)
  description String?      @db.Text
  priority    TaskPriority @default(Medium)
  dueDate     DateTime?    @map("due_date") @db.DateTime
  assignedTo  Int?         @map("assigned_to")
  status      TaskStatus   @default(Todo)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  company          Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedEmployee Employee?  @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
  comments         TaskComment[]

  @@index([companyId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@map("tasks")
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    String   @map("user_id") @db.VarChar(36)
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  task Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@map("task_comments")
}

// ============================================
// 5. Finance
// ============================================

enum InvoiceStatus {
  Paid
  Unpaid
  Overdue

  @@map("invoice_status")
}

model Invoice {
  id          Int           @id @default(autoincrement())
  companyId   Int           @map("company_id")
  clientId    Int           @map("client_id")
  invoiceNumber String      @unique @map("invoice_number") @db.VarChar(100)
  issueDate   DateTime      @map("issue_date") @db.Date
  dueDate     DateTime      @map("due_date") @db.Date
  totalAmount Decimal       @map("total_amount") @db.Decimal(12, 2)
  status      InvoiceStatus @default(Unpaid)
  notes       String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client       @relation(fields: [clientId], references: [id], onDelete: Restrict)
  items    InvoiceItem[]
  accountsReceivable AccountReceivable[]

  @@index([companyId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
  @@map("invoices")
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int      @map("invoice_id")
  description String   @db.VarChar(255)
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

enum TransactionType {
  Credit
  Debit

  @@map("transaction_type")
}

model Transaction {
  id          Int             @id @default(autoincrement())
  companyId   Int             @map("company_id")
  type        TransactionType
  categoryId  Int?            @map("category_id")
  amount      Decimal         @db.Decimal(12, 2)
  date        DateTime        @db.Date
  description String?         @db.Text
  reference   String?         @db.VarChar(255)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([type])
  @@index([categoryId])
  @@index([date])
  @@map("transactions")
}

model ExpenseCategory {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets     Budget[]

  @@index([companyId])
  @@map("expense_categories")
}

model Budget {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(255)
  categoryId  Int?     @map("category_id")
  amount      Decimal  @db.Decimal(12, 2)
  period      String   @db.VarChar(50) // Monthly, Quarterly, Yearly
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  spent       Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([categoryId])
  @@index([startDate])
  @@index([endDate])
  @@map("budgets")
}

model AccountPayable {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  vendorName  String   @map("vendor_name") @db.VarChar(255)
  amount      Decimal  @db.Decimal(12, 2)
  dueDate     DateTime @map("due_date") @db.Date
  status      String   @default("Pending") @db.VarChar(50) // Pending, Paid, Overdue
  description String?  @db.Text
  paidDate    DateTime? @map("paid_date") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_payable")
}

model AccountReceivable {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  clientId    Int?     @map("client_id")
  invoiceId   Int?     @map("invoice_id")
  amount      Decimal  @db.Decimal(12, 2)
  dueDate     DateTime @map("due_date") @db.Date
  status      String   @default("Pending") @db.VarChar(50) // Pending, Paid, Overdue
  description String?  @db.Text
  paidDate    DateTime? @map("paid_date") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([clientId])
  @@index([invoiceId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_receivable")
}

// ============================================
// 6. Social Integrations & Inbox
// ============================================

enum IntegrationProvider {
  facebook
  whatsapp
  chatwoot

  @@map("integration_provider")
}

enum WebhookMode {
  local
  live

  @@map("webhook_mode")
}

model Integration {
  id              Int                 @id @default(autoincrement())
  companyId       Int                 @map("company_id")
  provider        IntegrationProvider
  pageId          String              @map("page_id") @db.VarChar(255) // For Chatwoot: inbox_id
  accessToken     String              @map("access_token") @db.Text // Should be encrypted
  accountId       String?             @map("account_id") @db.VarChar(255) // For Chatwoot: account_id
  baseUrl         String?             @map("base_url") @db.VarChar(500) // For Chatwoot: base URL (optional, defaults to cloud)
  isActive        Boolean             @default(true) @map("is_active")
  webhookMode     WebhookMode?        @map("webhook_mode") @default(local) // For Chatwoot: local or live server mode
  isWebhookActive Boolean             @default(false) @map("is_webhook_active") // Enable/disable webhook (like live/test mode)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, provider, pageId])
  @@index([companyId])
  @@index([provider])
  @@index([isActive])
  @@map("integrations")
}

enum SocialPlatform {
  facebook
  chatwoot

  @@map("social_platform")
}

enum ConversationStatus {
  Open
  Closed

  @@map("conversation_status")
}

model SocialConversation {
  id               Int                @id @default(autoincrement())
  companyId        Int                @map("company_id")
  platform         SocialPlatform
  externalUserId   String             @map("external_user_id") @db.VarChar(255) // Sender's PSID from Facebook
  externalUserName String?            @map("external_user_name") @db.VarChar(255) // Sender's Name
  status           ConversationStatus @default(Open)
  lastMessageAt    DateTime?          @map("last_message_at") @db.DateTime
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages SocialMessage[]
  leads    Lead[]

  @@index([companyId])
  @@index([platform])
  @@index([externalUserId])
  @@index([status])
  @@index([lastMessageAt])
  @@map("social_conversations")
}

enum SenderType {
  customer
  agent

  @@map("sender_type")
}

model SocialMessage {
  id             Int        @id @default(autoincrement())
  conversationId Int        @map("conversation_id")
  senderType     SenderType @map("sender_type")
  content        String     @db.Text
  createdAt      DateTime   @default(now()) @map("created_at")

  conversation SocialConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("social_messages")
}

// ============================================
// 7. Company Management
// ============================================

model CompanyContact {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  type        String   @db.VarChar(50) // Phone, Email, Meeting, Note
  value       String   @db.VarChar(255)
  description String?  @db.Text
  date        DateTime @db.DateTime
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([date])
  @@map("company_contacts")
}

enum ContractStatus {
  Draft
  Active
  Expired
  Cancelled

  @@map("contract_status")
}

model Contract {
  id          Int            @id @default(autoincrement())
  companyId   Int            @map("company_id")
  title       String         @db.VarChar(255)
  description String?        @db.Text
  value       Decimal?       @db.Decimal(12, 2)
  startDate   DateTime       @map("start_date") @db.Date
  endDate     DateTime?      @map("end_date") @db.Date
  status      ContractStatus @default(Draft)
  documentUrl String?        @map("document_url") @db.VarChar(500)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([startDate])
  @@map("contracts")
}

// ============================================
// 8. System Settings & Root Items
// ============================================

model SystemSetting {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  key         String   @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
  @@index([key])
  @@map("system_settings")
}
