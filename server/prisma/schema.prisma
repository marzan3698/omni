// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// 0. Multi-Tenant (Company/Tenant)
// ============================================

model Company {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  address     String?  @db.Text
  industry    String?  @db.VarChar(100)
  website     String?  @db.VarChar(255)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users              User[]
  employees          Employee[]
  departments        Department[]
  clients            Client[]
  tasks              Task[]
  invoices           Invoice[]
  transactions       Transaction[]
  budgets            Budget[]
  accountsPayable    AccountPayable[]
  accountsReceivable AccountReceivable[]
  companyContacts    CompanyContact[]
  contracts          Contract[]
  integrations       Integration[]
  socialConversations SocialConversation[]
  expenseCategories  ExpenseCategory[]
  leadCategories     LeadCategory[]
  leadInterests      LeadInterest[]
  systemSettings    SystemSetting[]
  campaigns          Campaign[]
  products           Product[]
  productCategories  ProductCategory[]
  services           Service[]
  projects           Project[]
  reviews            Review[]
  blogPosts          BlogPost[]
  paymentGateways    PaymentGateway[]
  payments           Payment[]
  employeeGroups     EmployeeGroup[]

  @@index([name])
  @@index([isActive])
  @@map("companies")
}

// ============================================
// 1. Authentication & Users
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  permissions Json // e.g., {"can_manage_companies": true, "can_manage_inbox": false}
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model User {
  id           String   @id @default(uuid())
  name         String?  @db.VarChar(255)
  email        String   @db.VarChar(255)
  phone        String?  @db.VarChar(50)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  address      String?  @db.Text
  education    String?  @db.Text
  roleId       Int      @map("role_id")
  companyId    Int      @map("company_id")
  profileImage String?  @map("profile_image") @db.Text
  eSignature   String?  @map("e_signature") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  role     Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employee Employee?
  taskComments TaskComment[]
  createdLeads Lead[] @relation("LeadCreator")
  projects Project[]
  campaignClients CampaignClient[]
  createdEmployeeGroups EmployeeGroup[]

  @@unique([email, companyId])
  @@index([email])
  @@index([roleId])
  @@index([companyId])
  @@map("users")
}

// ============================================
// 2. Company Structure
// ============================================

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  companyId Int      @map("company_id")
  managerId Int?     @unique @map("manager_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  company          Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  manager          Employee?  @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  employees        Employee[] @relation("DepartmentEmployees")

  @@index([companyId])
  @@index([managerId])
  @@map("departments")
}

model Employee {
  id           Int       @id @default(autoincrement())
  userId     String    @unique @map("user_id") @db.VarChar(36)
  companyId  Int       @map("company_id")
  department String?   @db.VarChar(100)
  departmentId Int?    @map("department_id")
  designation String?  @db.VarChar(100)
  salary      Decimal?  @db.Decimal(10, 2)
  workHours   Decimal?  @map("work_hours") @db.Decimal(5, 2)
  holidays    Int?
  bonus       Decimal?  @db.Decimal(10, 2)
  responsibilities String? @db.Text
  joinDate    DateTime? @map("join_date") @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  company          Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  departmentRelation Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id], onDelete: SetNull)
  managedDepartment Department? @relation("DepartmentManager")

  // Relations
  assignedLeads Lead[]
  assignedTasks Task[]
  groups EmployeeGroupMember[]

  @@index([userId])
  @@index([companyId])
  @@index([departmentId])
  @@map("employees")
}

// ============================================
// 3. CRM (Sales)
// ============================================

model Client {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(255)
  contactInfo Json?    @map("contact_info") // e.g., {"phone": "+1234567890", "email": "client@example.com"}
  address     String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices Invoice[]
  accountsReceivable AccountReceivable[]
  payments Payment[]

  @@index([companyId])
  @@map("clients")
}

model LeadCategory {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leads   Lead[]

  @@index([companyId])
  @@index([isActive])
  @@map("lead_categories")
}

model LeadInterest {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  leads   Lead[]

  @@index([companyId])
  @@index([isActive])
  @@map("lead_interests")
}

enum LeadSource {
  Website
  Referral
  SocialMedia
  Email
  Phone
  Inbox
  Other

  @@map("lead_source")
}

enum LeadStatus {
  New
  Contacted
  Qualified
  Negotiation
  Won
  Lost

  @@map("lead_status")
}

enum CampaignType {
  reach
  sale
  research

  @@map("campaign_type")
}

enum Currency {
  BDT
  USD

  @@map("currency")
}

model Lead {
  id             Int        @id @default(autoincrement())
  createdBy      String     @map("created_by") // User ID who created the lead
  title          String     @db.VarChar(255)
  description    String?    @db.Text
  source         LeadSource @default(Website)
  status         LeadStatus @default(New)
  assignedTo     Int?       @map("assigned_to")
  value          Decimal?   @db.Decimal(12, 2)
  conversationId Int?       @map("conversation_id") // Link to SocialConversation if from inbox
  customerName   String?    @map("customer_name") @db.VarChar(255)
  phone          String?    @db.VarChar(50)
  categoryId     Int?       @map("category_id")
  interestId     Int?       @map("interest_id")
  campaignId     Int?       @map("campaign_id")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  createdByUser  User            @relation("LeadCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  assignedEmployee Employee?      @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
  conversation     SocialConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  category         LeadCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  interest         LeadInterest?  @relation(fields: [interestId], references: [id], onDelete: SetNull)
  campaign         Campaign?      @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([createdBy])
  @@index([assignedTo])
  @@index([status])
  @@index([conversationId])
  @@index([categoryId])
  @@index([interestId])
  @@index([campaignId])
  @@map("leads")
}

// ============================================
// 4. Task Management
// ============================================

enum TaskPriority {
  Low
  Medium
  High

  @@map("task_priority")
}

enum TaskStatus {
  Todo
  InProgress
  Done

  @@map("task_status")
}

model Task {
  id          Int          @id @default(autoincrement())
  companyId   Int          @map("company_id")
  title       String       @db.VarChar(255)
  description String?      @db.Text
  priority    TaskPriority @default(Medium)
  dueDate     DateTime?    @map("due_date") @db.DateTime
  assignedTo  Int?         @map("assigned_to")
  status      TaskStatus   @default(Todo)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  company          Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedEmployee Employee?  @relation(fields: [assignedTo], references: [id], onDelete: SetNull)
  comments         TaskComment[]

  @@index([companyId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@map("tasks")
}

model TaskComment {
  id        Int      @id @default(autoincrement())
  taskId    Int      @map("task_id")
  userId    String   @map("user_id") @db.VarChar(36)
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  task Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@map("task_comments")
}

// ============================================
// 5. Finance
// ============================================

enum InvoiceStatus {
  Paid
  Unpaid
  Overdue

  @@map("invoice_status")
}

model Invoice {
  id          Int           @id @default(autoincrement())
  companyId   Int           @map("company_id")
  clientId    Int           @map("client_id")
  projectId   Int?          @map("project_id")
  invoiceNumber String      @unique @map("invoice_number") @db.VarChar(100)
  issueDate   DateTime      @map("issue_date") @db.Date
  dueDate     DateTime      @map("due_date") @db.Date
  totalAmount Decimal       @map("total_amount") @db.Decimal(12, 2)
  status      InvoiceStatus @default(Unpaid)
  notes       String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  company  Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client       @relation(fields: [clientId], references: [id], onDelete: Restrict)
  project Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  items    InvoiceItem[]
  accountsReceivable AccountReceivable[]
  payments Payment[]
  campaigns CampaignInvoice[]

  @@index([companyId])
  @@index([clientId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceNumber])
  @@map("invoices")
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int      @map("invoice_id")
  description String   @db.VarChar(255)
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

// ============================================
// Payment Gateway & Payment Models
// ============================================

model PaymentGateway {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  accountType String   @map("account_type") @db.VarChar(50)
  accountNumber String @map("account_number") @db.VarChar(20)
  instructions String? @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  payments Payment[]
  
  @@index([companyId])
  @@index([isActive])
  @@map("payment_gateways")
}

enum PaymentStatus {
  Pending
  Approved
  Rejected
  Cancelled
  
  @@map("payment_status")
}

model Payment {
  id              Int           @id @default(autoincrement())
  companyId       Int           @map("company_id")
  invoiceId       Int           @map("invoice_id")
  projectId       Int?          @map("project_id")
  clientId        Int           @map("client_id")
  paymentGatewayId Int          @map("payment_gateway_id")
  amount          Decimal       @db.Decimal(12, 2)
  transactionId   String?       @map("transaction_id") @db.VarChar(100)
  paymentMethod   String        @map("payment_method") @db.VarChar(50)
  status          PaymentStatus @default(Pending)
  paidBy          String?       @map("paid_by") @db.VarChar(255)
  notes           String?       @db.Text
  adminNotes      String?       @map("admin_notes") @db.Text
  paidAt          DateTime?     @map("paid_at")
  verifiedAt      DateTime?     @map("verified_at")
  verifiedBy      String?       @map("verified_by") @db.VarChar(36)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice         Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  project         Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  client          Client        @relation(fields: [clientId], references: [id], onDelete: Restrict)
  paymentGateway  PaymentGateway @relation(fields: [paymentGatewayId], references: [id], onDelete: Restrict)
  
  @@index([companyId])
  @@index([invoiceId])
  @@index([projectId])
  @@index([clientId])
  @@index([status])
  @@index([paymentGatewayId])
  @@map("payments")
}

enum TransactionType {
  Credit
  Debit

  @@map("transaction_type")
}

model Transaction {
  id          Int             @id @default(autoincrement())
  companyId   Int             @map("company_id")
  type        TransactionType
  categoryId  Int?            @map("category_id")
  amount      Decimal         @db.Decimal(12, 2)
  date        DateTime        @db.Date
  description String?         @db.Text
  reference   String?         @db.VarChar(255)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([type])
  @@index([categoryId])
  @@index([date])
  @@map("transactions")
}

model ExpenseCategory {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(100)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  budgets     Budget[]

  @@index([companyId])
  @@map("expense_categories")
}

model Budget {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  name        String   @db.VarChar(255)
  categoryId  Int?     @map("category_id")
  amount      Decimal  @db.Decimal(12, 2)
  period      String   @db.VarChar(50) // Monthly, Quarterly, Yearly
  startDate   DateTime @map("start_date") @db.Date
  endDate     DateTime @map("end_date") @db.Date
  spent       Decimal  @default(0) @db.Decimal(12, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([categoryId])
  @@index([startDate])
  @@index([endDate])
  @@map("budgets")
}

model AccountPayable {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  vendorName  String   @map("vendor_name") @db.VarChar(255)
  amount      Decimal  @db.Decimal(12, 2)
  dueDate     DateTime @map("due_date") @db.Date
  status      String   @default("Pending") @db.VarChar(50) // Pending, Paid, Overdue
  description String?  @db.Text
  paidDate    DateTime? @map("paid_date") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_payable")
}

model AccountReceivable {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  clientId    Int?     @map("client_id")
  invoiceId   Int?     @map("invoice_id")
  amount      Decimal  @db.Decimal(12, 2)
  dueDate     DateTime @map("due_date") @db.Date
  status      String   @default("Pending") @db.VarChar(50) // Pending, Paid, Overdue
  description String?  @db.Text
  paidDate    DateTime? @map("paid_date") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([clientId])
  @@index([invoiceId])
  @@index([status])
  @@index([dueDate])
  @@map("accounts_receivable")
}

// ============================================
// 6. Social Integrations & Inbox
// ============================================

enum IntegrationProvider {
  facebook
  whatsapp
  chatwoot

  @@map("integration_provider")
}

enum WebhookMode {
  local
  live

  @@map("webhook_mode")
}

model Integration {
  id              Int                 @id @default(autoincrement())
  companyId       Int                 @map("company_id")
  provider        IntegrationProvider
  pageId          String              @map("page_id") @db.VarChar(255) // For Chatwoot: inbox_id
  accessToken     String              @map("access_token") @db.Text // Should be encrypted
  accountId       String?             @map("account_id") @db.VarChar(255) // For Chatwoot: account_id
  baseUrl         String?             @map("base_url") @db.VarChar(500) // For Chatwoot: base URL (optional, defaults to cloud)
  isActive        Boolean             @default(true) @map("is_active")
  webhookMode     WebhookMode?        @map("webhook_mode") @default(local) // For Chatwoot: local or live server mode
  isWebhookActive Boolean             @default(false) @map("is_webhook_active") // Enable/disable webhook (like live/test mode)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, provider, pageId])
  @@index([companyId])
  @@index([provider])
  @@index([isActive])
  @@map("integrations")
}

enum SocialPlatform {
  facebook
  chatwoot

  @@map("social_platform")
}

enum BlogStatus {
  Draft
  Published
  Archived

  @@map("blog_status")
}

enum ConversationStatus {
  Open
  Closed

  @@map("conversation_status")
}

model SocialConversation {
  id               Int                @id @default(autoincrement())
  companyId        Int                @map("company_id")
  platform         SocialPlatform
  externalUserId   String             @map("external_user_id") @db.VarChar(255) // Sender's PSID from Facebook
  externalUserName String?            @map("external_user_name") @db.VarChar(255) // Sender's Name
  status           ConversationStatus @default(Open)
  lastMessageAt    DateTime?          @map("last_message_at") @db.DateTime
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages SocialMessage[]
  leads    Lead[]

  @@index([companyId])
  @@index([platform])
  @@index([externalUserId])
  @@index([status])
  @@index([lastMessageAt])
  @@map("social_conversations")
}

enum SenderType {
  customer
  agent

  @@map("sender_type")
}

model SocialMessage {
  id             Int        @id @default(autoincrement())
  conversationId Int        @map("conversation_id")
  senderType     SenderType @map("sender_type")
  content        String     @db.Text
  createdAt      DateTime   @default(now()) @map("created_at")

  conversation SocialConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("social_messages")
}

// ============================================
// 7. Content
// ============================================

model Review {
  id          Int       @id @default(autoincrement())
  companyId   Int?      @map("company_id")
  authorName  String    @map("author_name") @db.VarChar(150)
  role        String?   @db.VarChar(150)
  rating      Int
  comment     String    @db.Text
  isFeatured  Boolean   @default(false) @map("is_featured")
  createdAt   DateTime  @default(now()) @map("created_at")

  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@map("reviews")
}

model BlogPost {
  id          Int        @id @default(autoincrement())
  companyId   Int?       @map("company_id")
  title       String     @db.VarChar(255)
  slug        String     @unique @db.VarChar(255)
  excerpt     String?    @db.VarChar(500)
  content     String     @db.Text
  coverImage  String?    @map("cover_image") @db.VarChar(500)
  tags        Json?
  status      BlogStatus @default(Published)
  publishedAt DateTime?  @map("published_at") @db.DateTime
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([status])
  @@map("blog_posts")
}

// ============================================
// 8. Company Management
// ============================================

model CompanyContact {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  type        String   @db.VarChar(50) // Phone, Email, Meeting, Note
  value       String   @db.VarChar(255)
  description String?  @db.Text
  date        DateTime @db.DateTime
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([date])
  @@map("company_contacts")
}

enum ContractStatus {
  Draft
  Active
  Expired
  Cancelled

  @@map("contract_status")
}

model Contract {
  id          Int            @id @default(autoincrement())
  companyId   Int            @map("company_id")
  title       String         @db.VarChar(255)
  description String?        @db.Text
  value       Decimal?       @db.Decimal(12, 2)
  startDate   DateTime       @map("start_date") @db.Date
  endDate     DateTime?      @map("end_date") @db.Date
  status      ContractStatus @default(Draft)
  documentUrl String?        @map("document_url") @db.VarChar(500)
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([startDate])
  @@map("contracts")
}

// ============================================
// 8. System Settings & Root Items
// ============================================

model SystemSetting {
  id          Int      @id @default(autoincrement())
  companyId   Int      @map("company_id")
  key         String   @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, key])
  @@index([companyId])
  @@index([key])
  @@map("system_settings")
}

// ============================================
// 9. Campaign Management
// ============================================

model Campaign {
  id          Int          @id @default(autoincrement())
  companyId   Int          @map("company_id")
  projectId   Int          @map("project_id")
  name        String       @db.VarChar(255)
  description String?      @db.Text
  startDate   DateTime     @map("start_date") @db.Date
  endDate     DateTime     @map("end_date") @db.Date
  budget      Decimal      @db.Decimal(12, 2)
  type        CampaignType @default(sale)
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  leads   Lead[]
  products CampaignProduct[]
  clients CampaignClient[]
  invoices CampaignInvoice[]
  groups CampaignGroup[]

  @@index([companyId])
  @@index([projectId])
  @@index([type])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
  @@map("campaigns")
}

// ============================================
// 10. Product Management
// ============================================

model ProductCategory {
  id          Int       @id @default(autoincrement())
  companyId   Int       @map("company_id")
  name        String    @db.VarChar(255)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products Product[]

  @@index([companyId])
  @@index([name])
  @@map("product_categories")
}

model Product {
  id            Int       @id @default(autoincrement())
  companyId     Int       @map("company_id")
  categoryId    Int       @map("category_id")
  name          String    @db.VarChar(255)
  description   String?   @db.Text
  purchasePrice Decimal   @map("purchase_price") @db.Decimal(12, 2)
  salePrice     Decimal   @map("sale_price") @db.Decimal(12, 2)
  currency      Currency  @default(BDT)
  productCompany String?  @map("product_company") @db.VarChar(255)
  imageUrl      String?   @map("image_url") @db.VarChar(500)
  quickReplies  Json?     @map("quick_replies")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  company  Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  campaigns CampaignProduct[]

  @@index([companyId])
  @@index([categoryId])
  @@index([name])
  @@index([currency])
  @@map("products")
}

// ============================================
// 11. Campaign Product Assignment
// ============================================

model CampaignProduct {
  id         Int      @id @default(autoincrement())
  campaignId Int      @map("campaign_id")
  productId  Int      @map("product_id")
  createdAt  DateTime @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([campaignId, productId])
  @@index([campaignId])
  @@index([productId])
  @@map("campaign_products")
}

// ============================================
// 12. Project Management
// ============================================

enum ProjectStatus {
  Draft
  Submitted
  StartedWorking
  InProgress
  Completed
  Cancelled

  @@map("project_status")
}

model Project {
  id          Int          @id @default(autoincrement())
  companyId   Int          @map("company_id")
  clientId    String       @map("client_id") @db.VarChar(36)
  serviceId   Int?         @map("service_id")
  title       String       @db.VarChar(255)
  description String?      @db.Text
  budget      Decimal      @db.Decimal(12, 2)
  deliveryStartDate DateTime? @map("delivery_start_date") @db.Date
  deliveryEndDate DateTime? @map("delivery_end_date") @db.Date
  time        String       @db.VarChar(100)
  status      ProjectStatus @default(Draft)
  signature   String?      @db.Text
  documentUrl String?       @map("document_url") @db.VarChar(500)
  signedAt    DateTime?    @map("signed_at") @db.DateTime
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client User @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  invoices Invoice[]
  payments Payment[]
  campaigns Campaign[]

  @@index([companyId])
  @@index([clientId])
  @@index([serviceId])
  @@index([status])
  @@map("projects")
}

// ============================================
// 13. Services
// ============================================

model Service {
  id                Int      @id @default(autoincrement())
  companyId         Int      @map("company_id")
  title             String   @db.VarChar(255)
  details           String   @db.Text
  pricing           Decimal  @db.Decimal(12, 2)
  deliveryStartDate DateTime @map("delivery_start_date") @db.Date
  deliveryEndDate   DateTime @map("delivery_end_date") @db.Date
  attributes        Json     // { keyValuePairs: {[key: string]: string}, tags: string[] }
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projects Project[]

  @@index([companyId])
  @@index([isActive])
  @@map("services")
}

// ============================================
// 14. Campaign Client Assignment
// ============================================

model CampaignClient {
  id         Int      @id @default(autoincrement())
  campaignId Int      @map("campaign_id")
  clientId   String   @map("client_id") @db.VarChar(36)
  createdAt  DateTime @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  client   User     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([campaignId, clientId])
  @@index([campaignId])
  @@index([clientId])
  @@map("campaign_clients")
}

// ============================================
// 15. Campaign Employee Assignment (DEPRECATED - Removed)
// ============================================

// ============================================
// 16. Employee Groups
// ============================================

model EmployeeGroup {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  description String    @db.Text
  companyId   Int       @map("company_id")
  createdById String    @map("created_by_id") @db.VarChar(36)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator     User      @relation(fields: [createdById], references: [id], onDelete: Restrict)
  members     EmployeeGroupMember[]
  campaigns   CampaignGroup[]

  @@index([companyId])
  @@index([createdById])
  @@map("employee_groups")
}

model EmployeeGroupMember {
  id         Int      @id @default(autoincrement())
  groupId    Int      @map("group_id")
  employeeId Int      @map("employee_id")
  createdAt  DateTime @default(now()) @map("created_at")

  group    EmployeeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  employee Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([groupId, employeeId])
  @@index([groupId])
  @@index([employeeId])
  @@map("employee_group_members")
}

// ============================================
// 17. Campaign Invoice Assignment
// ============================================

model CampaignInvoice {
  id         Int      @id @default(autoincrement())
  campaignId Int      @map("campaign_id")
  invoiceId  Int      @map("invoice_id")
  createdAt  DateTime @default(now()) @map("created_at")

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  invoice  Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([campaignId, invoiceId])
  @@index([campaignId])
  @@index([invoiceId])
  @@map("campaign_invoices")
}

// ============================================
// 18. Campaign Group Assignment
// ============================================

model CampaignGroup {
  id         Int      @id @default(autoincrement())
  campaignId Int      @map("campaign_id")
  groupId    Int      @map("group_id")
  createdAt  DateTime @default(now()) @map("created_at")

  campaign Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  group    EmployeeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([campaignId, groupId])
  @@index([campaignId])
  @@index([groupId])
  @@map("campaign_groups")
}
