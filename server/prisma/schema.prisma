// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. Authentication & Users
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(50)
  permissions Json // e.g., {"can_delete_users": true, "can_reply_social": false}
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("roles")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  roleId       Int      @map("role_id")
  profileImage String?  @map("profile_image") @db.VarChar(500)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  role     Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  employee Employee?

  @@index([email])
  @@index([roleId])
  @@map("users")
}

// ============================================
// 2. Company Structure
// ============================================

model Department {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  managerId Int?     @unique @map("manager_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  manager   Employee?  @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  employees Employee[] @relation("DepartmentEmployees")

  @@index([managerId])
  @@map("departments")
}

model Employee {
  id           Int       @id @default(autoincrement())
  userId       String    @unique @map("user_id") @db.VarChar(36)
  department   String?   @db.VarChar(100)
  departmentId Int?      @map("department_id")
  designation  String?   @db.VarChar(100)
  salary       Decimal?  @db.Decimal(10, 2)
  joinDate     DateTime? @map("join_date") @db.Date
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  departmentRelation Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id], onDelete: SetNull)
  managedDepartment  Department? @relation("DepartmentManager")

  // Relations
  assignedLeads Lead[]
  assignedTasks Task[]

  @@index([userId])
  @@index([departmentId])
  @@map("employees")
}

// ============================================
// 3. CRM (Sales)
// ============================================

model Client {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  contactInfo Json?    @map("contact_info") // e.g., {"phone": "+1234567890", "email": "client@example.com"}
  address     String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  invoices Invoice[]

  @@map("clients")
}

enum LeadSource {
  Website
  Referral
  SocialMedia
  Email
  Phone
  Other

  @@map("lead_source")
}

enum LeadStatus {
  New
  Contacted
  Qualified
  Negotiation
  Won
  Lost

  @@map("lead_status")
}

model Lead {
  id         Int        @id @default(autoincrement())
  title      String     @db.VarChar(255)
  source     LeadSource @default(Website)
  status     LeadStatus @default(New)
  assignedTo Int?       @map("assigned_to")
  value      Decimal?   @db.Decimal(12, 2)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  assignedEmployee Employee? @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([assignedTo])
  @@index([status])
  @@map("leads")
}

// ============================================
// 4. Task Management
// ============================================

enum TaskPriority {
  Low
  Medium
  High

  @@map("task_priority")
}

enum TaskStatus {
  Todo
  InProgress
  Done

  @@map("task_status")
}

model Task {
  id          Int          @id @default(autoincrement())
  title       String       @db.VarChar(255)
  description String?      @db.Text
  priority    TaskPriority @default(Medium)
  dueDate     DateTime?    @map("due_date") @db.DateTime
  assignedTo  Int?         @map("assigned_to")
  status      TaskStatus   @default(Todo)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  assignedEmployee Employee? @relation(fields: [assignedTo], references: [id], onDelete: SetNull)

  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@map("tasks")
}

// ============================================
// 5. Finance
// ============================================

enum InvoiceStatus {
  Paid
  Unpaid
  Overdue

  @@map("invoice_status")
}

model Invoice {
  id          Int           @id @default(autoincrement())
  clientId    Int           @map("client_id")
  issueDate   DateTime      @map("issue_date") @db.Date
  dueDate     DateTime      @map("due_date") @db.Date
  totalAmount Decimal       @map("total_amount") @db.Decimal(12, 2)
  status      InvoiceStatus @default(Unpaid)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Restrict)

  @@index([clientId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

enum TransactionType {
  Credit
  Debit

  @@map("transaction_type")
}

model Transaction {
  id          Int             @id @default(autoincrement())
  type        TransactionType
  category    String          @db.VarChar(100) // Salary, Rent, Sales, etc.
  amount      Decimal         @db.Decimal(12, 2)
  date        DateTime        @db.Date
  description String?         @db.Text
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@index([type])
  @@index([category])
  @@index([date])
  @@map("transactions")
}

// ============================================
// 6. Social Integrations & Inbox
// ============================================

enum IntegrationProvider {
  facebook
  whatsapp
  chatwoot

  @@map("integration_provider")
}

enum WebhookMode {
  local
  live

  @@map("webhook_mode")
}

model Integration {
  id              Int                 @id @default(autoincrement())
  provider        IntegrationProvider
  pageId          String              @map("page_id") @db.VarChar(255) // For Chatwoot: inbox_id
  accessToken     String              @map("access_token") @db.Text // Should be encrypted
  accountId       String?             @map("account_id") @db.VarChar(255) // For Chatwoot: account_id
  baseUrl         String?             @map("base_url") @db.VarChar(500) // For Chatwoot: base URL (optional, defaults to cloud)
  isActive        Boolean             @default(true) @map("is_active")
  webhookMode     WebhookMode?        @map("webhook_mode") @default(local) // For Chatwoot: local or live server mode
  isWebhookActive Boolean             @default(false) @map("is_webhook_active") // Enable/disable webhook (like live/test mode)
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@unique([provider, pageId])
  @@index([provider])
  @@index([isActive])
  @@map("integrations")
}

enum SocialPlatform {
  facebook
  chatwoot

  @@map("social_platform")
}

enum ConversationStatus {
  Open
  Closed

  @@map("conversation_status")
}

model SocialConversation {
  id               Int                @id @default(autoincrement())
  platform         SocialPlatform
  externalUserId   String             @map("external_user_id") @db.VarChar(255) // Sender's PSID from Facebook
  externalUserName String?            @map("external_user_name") @db.VarChar(255) // Sender's Name
  status           ConversationStatus @default(Open)
  lastMessageAt    DateTime?          @map("last_message_at") @db.DateTime
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")

  messages SocialMessage[]

  @@index([platform])
  @@index([externalUserId])
  @@index([status])
  @@index([lastMessageAt])
  @@map("social_conversations")
}

enum SenderType {
  customer
  agent

  @@map("sender_type")
}

model SocialMessage {
  id             Int        @id @default(autoincrement())
  conversationId Int        @map("conversation_id")
  senderType     SenderType @map("sender_type")
  content        String     @db.Text
  createdAt      DateTime   @default(now()) @map("created_at")

  conversation SocialConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("social_messages")
}
